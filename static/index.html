<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Link Service</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background: #0052a3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 16px;
            border-radius: 4px;
            margin-top: 16px;
        }
        .status.info {
            background: #e3f2fd;
            color: #1565c0;
        }
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .status.warning {
            background: #fff3e0;
            color: #ef6c00;
        }
        .hidden {
            display: none;
        }
        .tx-link {
            word-break: break-all;
        }
        .tx-link a {
            color: #0066cc;
        }
        #wallet-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }
        .connected {
            color: #2e7d32 !important;
        }
        button.connected {
            background: #2e7d32;
            color: white !important;
        }
        button.connected:hover {
            background: #1b5e20;
        }
        pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .section-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <h1>Payment</h1>

    <!-- Pay Section -->
    <div class="card">
        <h2>Pay</h2>
        <div id="wallet-status">Wallet: Not connected</div>
        <button id="connect-btn" onclick="connectWallet()">Connect Wallet</button>
        <br><br>
        <label for="payment-url">Payment URL or ID</label>
        <input type="text" id="payment-url" placeholder="Payment ID or full URL">
        <button id="pay-btn" onclick="processPayment()" disabled>Pay Now</button>
        <div id="pay-result" class="status hidden"></div>
    </div>

    <!-- Check Status Section -->
    <div class="card">
        <h2>Check Payment Status</h2>
        <label for="status-url">Payment URL or ID</label>
        <input type="text" id="status-url" placeholder="Payment ID or full URL">
        <button id="status-btn" onclick="checkStatus()">Check Status</button>
        <div id="status-result" class="status hidden"></div>
    </div>

    <p style="text-align: center; margin-top: 20px;">
        <a href="/create" style="color: #0066cc;">Create a new payment link</a>
    </p>

    <script>
        let provider = null;
        let signer = null;
        let userAddress = null;

        // Server configuration (loaded from /config endpoint)
        let serverConfig = null;

        // ERC-3009 ABI for transferWithAuthorization
        const USDC_ABI = [
            "function transferWithAuthorization(address from, address to, uint256 value, uint256 validAfter, uint256 validBefore, bytes32 nonce, uint8 v, bytes32 r, bytes32 s)",
            "function permit(address owner, address spender, uint256 value, uint256 deadline, uint8 v, bytes32 r, bytes32 s)",
            "function transferFrom(address from, address to, uint256 amount) returns (bool)",
            "function balanceOf(address account) view returns (uint256)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function name() view returns (string)",
            "function version() view returns (string)",
            "function nonces(address owner) view returns (uint256)",
            "function DOMAIN_SEPARATOR() view returns (bytes32)"
        ];

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showResult('pay-result', 'error', 'Please install MetaMask or another Web3 wallet');
                    return;
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                const network = await provider.getNetwork();
                document.getElementById('wallet-status').innerHTML =
                    `Wallet: <span class="connected">${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</span> (Chain ID: ${network.chainId})`;
                document.getElementById('pay-btn').disabled = false;
                const connectBtn = document.getElementById('connect-btn');
                connectBtn.textContent = 'Connected';
                connectBtn.classList.add('connected');

                showResult('pay-result', 'success', `Connected: ${userAddress}`);
            } catch (error) {
                showResult('pay-result', 'error', `Failed to connect wallet: ${error.message}`);
            }
        }

        async function processPayment() {
            const paymentInput = document.getElementById('payment-url').value;
            if (!paymentInput) {
                showResult('pay-result', 'error', 'Please enter a payment URL or ID');
                return;
            }

            const paymentUrl = getPaymentUrl(paymentInput, 'pay');
            if (!paymentUrl) {
                showResult('pay-result', 'error', 'Invalid payment URL or ID');
                return;
            }

            if (!signer) {
                showResult('pay-result', 'error', 'Please connect your wallet first');
                return;
            }

            try {
                document.getElementById('pay-btn').disabled = true;
                showResult('pay-result', 'info', 'Fetching payment requirements...');

                // Step 1: Fetch payment requirements
                const response = await fetch(paymentUrl);
                console.log('Initial fetch status:', response.status);

                // Handle different response statuses
                if (response.status === 200) {
                    const data = await response.json();
                    if (data.status === 'paid') {
                        showResult('pay-result', 'success',
                            `Already paid!<br><br>` +
                            `<strong>TX Hash:</strong> <span class="tx-link">${data.tx}</span>`
                        );
                        return;
                    }
                    // If 200 but not paid, something unexpected
                    showResult('pay-result', 'error', `Unexpected response: ${JSON.stringify(data)}`);
                    return;
                }

                if (response.status !== 402) {
                    const text = await response.text();
                    showResult('pay-result', 'error', `Unexpected response (${response.status}): ${text}`);
                    return;
                }

                // Parse 402 response for payment requirements
                const paymentReq = await response.json();
                console.log('Payment requirements:', paymentReq);

                if (!paymentReq.accepts || paymentReq.accepts.length === 0) {
                    showResult('pay-result', 'error', 'No payment options available');
                    return;
                }

                // Get the first payment requirement
                const req = paymentReq.accepts[0];
                const network = req.network;
                const expectedChainId = serverConfig?.chainId;

                if (!expectedChainId) {
                    showResult('pay-result', 'error', 'Server config not loaded');
                    return;
                }

                // Check network
                const currentNetwork = await provider.getNetwork();
                if (Number(currentNetwork.chainId) !== expectedChainId) {
                    showResult('pay-result', 'warning',
                        `Please switch to ${network} (Chain ID: ${expectedChainId}). Current: ${currentNetwork.chainId}`
                    );

                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + expectedChainId.toString(16) }],
                        });
                        // Reconnect after switch
                        provider = new ethers.BrowserProvider(window.ethereum);
                        signer = await provider.getSigner();
                    } catch (switchError) {
                        showResult('pay-result', 'error', `Failed to switch network: ${switchError.message}`);
                        return;
                    }
                }

                showResult('pay-result', 'info', 'Preparing payment signature...');

                // Step 2: Create and sign the payment
                const usdcAddress = req.asset;
                const usdc = new ethers.Contract(usdcAddress, USDC_ABI, signer);

                const amount = BigInt(req.maxAmountRequired);
                const payTo = req.payTo;
                const validAfter = 0;
                const validBefore = Math.floor(Date.now() / 1000) + req.maxTimeoutSeconds;
                const nonce = ethers.hexlify(ethers.randomBytes(32));

                // Get token name and version for EIP-712 domain
                const tokenName = req.extra?.name || await usdc.name();
                const tokenVersion = req.extra?.version || '2';

                // EIP-712 domain
                const domain = {
                    name: tokenName,
                    version: tokenVersion,
                    chainId: expectedChainId,
                    verifyingContract: usdcAddress
                };

                // EIP-712 types for TransferWithAuthorization
                const types = {
                    TransferWithAuthorization: [
                        { name: 'from', type: 'address' },
                        { name: 'to', type: 'address' },
                        { name: 'value', type: 'uint256' },
                        { name: 'validAfter', type: 'uint256' },
                        { name: 'validBefore', type: 'uint256' },
                        { name: 'nonce', type: 'bytes32' }
                    ]
                };

                const message = {
                    from: userAddress,
                    to: payTo,
                    value: amount,
                    validAfter: validAfter,
                    validBefore: validBefore,
                    nonce: nonce
                };

                showResult('pay-result', 'info', 'Please sign the transaction in your wallet...');

                // Sign the typed data
                const signature = await signer.signTypedData(domain, types, message);
                const sig = ethers.Signature.from(signature);

                // Create the payment payload
                const paymentPayload = {
                    x402Version: 1,
                    scheme: 'exact',
                    network: network,
                    payload: {
                        signature: signature,
                        authorization: {
                            from: userAddress,
                            to: payTo,
                            value: amount.toString(),
                            validAfter: validAfter.toString(),
                            validBefore: validBefore.toString(),
                            nonce: nonce
                        }
                    }
                };

                // Base64 encode the payload
                const paymentHeader = btoa(JSON.stringify(paymentPayload));

                console.log('Payment payload:', paymentPayload);
                console.log('X-Payment header length:', paymentHeader.length);
                console.log('X-Payment header (first 100 chars):', paymentHeader.substring(0, 100));
                console.log('Submitting to URL:', paymentUrl);

                showResult('pay-result', 'info', 'Submitting payment...');

                // Step 3: Submit payment with X-Payment header
                console.log('About to fetch with X-Payment header...');
                const payResponse = await fetch(paymentUrl, {
                    method: 'GET',
                    headers: {
                        'X-Payment': paymentHeader,
                        'Accept': 'application/json'
                    }
                });

                console.log('Payment response status:', payResponse.status);
                console.log('Payment response headers:', [...payResponse.headers.entries()]);

                const payResult = await payResponse.json();
                console.log('Payment result:', payResult);

                if (payResponse.ok && payResult.status === 'paid') {
                    const explorerUrl = serverConfig.explorerUrl + payResult.tx;
                    showResult('pay-result', 'success',
                        `Payment successful!<br><br>` +
                        `<strong>TX Hash:</strong><br>` +
                        `<span class="tx-link"><a href="${explorerUrl}" target="_blank">${payResult.tx}</a></span>`
                    );
                } else {
                    showResult('pay-result', 'error',
                        `Payment failed: ${payResult.error || JSON.stringify(payResult)}`
                    );
                }

            } catch (error) {
                console.error('Payment error:', error);
                showResult('pay-result', 'error', `Payment failed: ${error.message}`);
            } finally {
                document.getElementById('pay-btn').disabled = false;
            }
        }

        async function checkStatus() {
            const statusInput = document.getElementById('status-url').value;
            if (!statusInput) {
                showResult('status-result', 'error', 'Please enter a payment URL or ID');
                return;
            }

            const statusUrl = getPaymentUrl(statusInput, 'status');
            if (!statusUrl) {
                showResult('status-result', 'error', 'Invalid payment URL or ID');
                return;
            }

            try {
                document.getElementById('status-btn').disabled = true;
                showResult('status-result', 'info', 'Checking status...');

                const response = await fetch(statusUrl);
                const data = await response.json();

                if (response.ok) {
                    if (data.paid) {
                        showResult('status-result', 'success',
                            `<strong>Status:</strong> Paid<br>` +
                            `<strong>Amount:</strong> $${data.amount} USD<br>` +
                            `<strong>TX Hash:</strong><br>` +
                            `<span class="tx-link">${data.tx}</span>`
                        );
                    } else {
                        showResult('status-result', 'warning',
                            `<strong>Status:</strong> Pending<br>` +
                            `<strong>Amount:</strong> $${data.amount} USD`
                        );
                    }
                } else {
                    showResult('status-result', 'error', `Error: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                showResult('status-result', 'error', `Failed to check status: ${error.message}`);
            } finally {
                document.getElementById('status-btn').disabled = false;
            }
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.innerHTML = message;
            element.classList.remove('hidden');
        }

        // Helper function to normalize payment input to full URL
        function getPaymentUrl(input, type = 'pay') {
            if (!input) return null;
            input = input.trim();

            // If it's already a full URL, extract the ID and reconstruct
            if (input.startsWith('http://') || input.startsWith('https://')) {
                // Extract payment ID from URL path
                const match = input.match(/\/(pay|status)\/([a-zA-Z0-9-]+)/);
                if (match) {
                    const paymentId = match[2];
                    return `${window.location.origin}/${type}/${paymentId}`;
                }
                return input; // Return as-is if we can't parse it
            }

            // It's just a payment ID, construct the full URL
            return `${window.location.origin}/${type}/${input}`;
        }

        // Pre-fill from URL query parameter
        function prefillFromQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get('pid');
            if (pid) {
                document.getElementById('payment-url').value = pid;
                document.getElementById('status-url').value = pid;
            }
        }

        // Load server configuration
        async function loadConfig() {
            try {
                const response = await fetch('/config');
                if (response.ok) {
                    serverConfig = await response.json();
                    console.log('Server config loaded:', serverConfig);
                } else {
                    console.error('Failed to load config:', response.status);
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Initialize on page load
        window.addEventListener('load', async () => {
            await loadConfig();
            prefillFromQueryParams();
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        });
    </script>
</body>
</html>
